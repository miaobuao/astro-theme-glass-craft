---
import type { InferGetStaticPropsType } from 'astro'
import { getCollection, render } from 'astro:content'
import BlogPostLayout from '../../layouts/BlogPostLayout.astro'
import { createFallbackBlogFrontMatterProcessor } from '../../utils/fallback-blog-frontmatter'

export async function getStaticPaths() {
	const posts = await getCollection('blog')
	const fallback = createFallbackBlogFrontMatterProcessor({
		options: {
			slugify: true,
		},
	})
	const unslugifyFallback = createFallbackBlogFrontMatterProcessor({
		options: {
			slugify: false,
		},
	})
	const slugifyPosts = await Promise.all(posts.map(fallback))
	const unslugifyPosts = await Promise.all(posts.map(unslugifyFallback))

	const paths = [
		...slugifyPosts.map((post) => ({
			params: { slug: post.frontMatter.slug },
			props: { post, slugify: true },
		})),
		...unslugifyPosts.map((post) => ({
			params: { slug: post.frontMatter.slug },
			props: { post, slugify: false },
		})),
	]
	return paths
}

type Props = InferGetStaticPropsType<typeof getStaticPaths>
const { post } = Astro.props

const { Content } = await render(post.entry)

const title = post.frontMatter.title
const description = post.frontMatter.description
const pubDate = post.frontMatter.publishDate
---

<BlogPostLayout {title} {description} {pubDate}>
	<Content />
</BlogPostLayout>
