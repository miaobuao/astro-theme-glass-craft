---
import BaseLayout from '../layouts/BaseLayout.astro'
import BlogList from '../components/astro/BlogList.astro'
import PagefindSearchModal from '../components/Pagefind/PagefindSearchModal.astro'
import PagefindSearchButton from '../components/Pagefind/PagefindSearchButton.astro'
import { getCollection } from 'astro:content'
import { createFallbackBlogFrontMatterProcessor } from '../utils/fallback-blog-frontmatter'
import { config } from '../consts'

const blogPosts = await getCollection('blog')
const fallback = createFallbackBlogFrontMatterProcessor({
	options: {
		slugify: config.slugifyArticleUrl,
	},
})
const processedPosts = await Promise.all(blogPosts.map(fallback))

const sortedPosts = processedPosts
	.filter((post) => post.frontMatter.isDraft === false)
	.toSorted((a, b) => {
		return a.frontMatter.publishDate > b.frontMatter.publishDate
			? -1
			: a.frontMatter.publishDate < b.frontMatter.publishDate
				? 1
				: 0
	})
---

<script type="module">
	if (!window.pagefind) {
		const pagefind = await import('/pagefind/pagefind.js')
		pagefind.init()
		window.pagefind = pagefind
	}
</script>

<BaseLayout showAuthorInfo showScrollProgress={config.scrollProgress}>
	<BlogList posts={sortedPosts} />
	<PagefindSearchButton />
	<PagefindSearchModal />
</BaseLayout>
