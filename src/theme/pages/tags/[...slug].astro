---
import type { InferGetStaticPropsType } from 'astro'
import { getCollection } from 'astro:content'
import { createFallbackBlogFrontMatterProcessor } from '../../utils/fallback-blog-frontmatter'
import { config } from '../../consts'
import BaseLayout from '../../layouts/BaseLayout.astro'
import moment from 'moment'

export async function getStaticPaths() {
	const fallback = createFallbackBlogFrontMatterProcessor({
		options: {
			slugify: config.slugifyArticleUrl,
		},
	})
	const posts = await getCollection('blog').then((posts) =>
		Promise.all(posts.filter((p) => !p.data.draft).map(fallback)),
	)

	// Collect all unique tags
	const tagMap = new Map<string, typeof posts>()
	for (const post of posts) {
		for (const tag of post.frontMatter.tags) {
			if (!tagMap.has(tag)) {
				tagMap.set(tag, [])
			}
			tagMap.get(tag)!.push(post)
		}
	}

	// Sort posts within each tag by publish date (newest first)
	const paths = Array.from(tagMap.entries()).map(([tag, tagPosts]) => {
		const sortedPosts = tagPosts.sort((a, b) => {
			return a.frontMatter.publishDate > b.frontMatter.publishDate
				? -1
				: a.frontMatter.publishDate < b.frontMatter.publishDate
					? 1
					: 0
		})
		return {
			params: { slug: tag },
			props: { tag, posts: sortedPosts },
		}
	})

	return paths
}

type Props = InferGetStaticPropsType<typeof getStaticPaths>
const { tag, posts } = Astro.props
---

<BaseLayout
	showAuthorInfo
	showScrollProgress={config.scrollProgress}
	title={`Tag: ${tag}`}
>
	<div class="flex flex-col gap-4 max-sm:glassmorphism max-sm:p-2 rounded-lg">
		<div class="flex items-center gap-2 p-1">
			<h1 class="text-2xl sm:text-4xl font-bold">
				<span class="text-primary-500 dark:text-primary-400">#</span>
				{tag}
			</h1>
			<span class="text-base sm:text-lg opacity-60">
				({posts.length} {posts.length === 1 ? 'post' : 'posts'})
			</span>
		</div>
		<div class="flex flex-col gap-1">
			{
				posts.map((post) => (
					<a
						href={`/blog/${post.frontMatter.slug}`}
						class="p-2 rounded-sm transition-all hover:glassmorphism max-sm:active:glassmorphism border-none!"
					>
						<div class="flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-4">
							<div class="flex-1 font-semibold">{post.frontMatter.title}</div>
							<span class="shrink-0 text-sm opacity-60">
								{moment(post.frontMatter.publishDate).format('YYYY-MM-DD')}
							</span>
						</div>
					</a>
				))
			}
		</div>
	</div>
</BaseLayout>
